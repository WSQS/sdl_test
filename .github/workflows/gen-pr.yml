name: Generate PR with AI

on:
  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number to implement"
        required: true
        type: number

jobs:
  gen-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: read

    env:
      GH_TOKEN: ${{ github.token }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set reusable strings
        # Turn repeated input strings (such as the build output directory) into step outputs. These step outputs can be used throughout the workflow file.
        id: strings
        shell: bash
        run: |
          echo "build-output-dir=$GITHUB_WORKSPACE/build" >> "$GITHUB_OUTPUT"
          echo "install-dir=$GITHUB_WORKSPACE/install/ubuntu-latest-clang-Debug" >> "$GITHUB_OUTPUT"

      - name: Install SDL windowing deps (Linux)
        run: |
          sudo apt update
          sudo apt install -y \
              build-essential cmake ninja-build pkg-config gcc clang git python3 \
              libasound2-dev libjack-jackd2-dev libpulse-dev \
              xorg-dev libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev libxtst-dev \
              libxkbcommon-dev wayland-protocols libwayland-dev \
              libdrm-dev mesa-utils mesa-common-dev

      - name: Configure CMake
        # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
        # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
        run: >
          cmake -B ${{ steps.strings.outputs.build-output-dir }}
          -DCMAKE_CXX_COMPILER=clang++
          -DCMAKE_C_COMPILER=clang
          -DCMAKE_BUILD_TYPE=Debug
          -S $GITHUB_WORKSPACE
          -G "Ninja Multi-Config"

      - name: Build
        run: cmake --build ${{ steps.strings.outputs.build-output-dir }}

      - name: Generate PR from issue using OpenRouter
        uses: WillBooster/gen-pr@v4.1.4
        with:
          issue-number: ${{ inputs.issue-number }}
          aider-extra-args: "--model openrouter/kwaipilot/kat-coder-pro:free"
          verbose: true
